##### ÈõÜÊàêRobotFrameworkÂÆûÁé∞È™åÊî∂ÊµãËØï

‰∏Ä‰∏™Âü∫‰∫éPythonËØ≠Ë®ÄÔºåÁî®‰∫éÈ™åÊî∂ÊµãËØïÂíåÈ™åÊî∂ÊµãËØïÈ©±Âä®ÂºÄÂèëÔºàATDDÔºâÁöÑÈÄöÁî®ÊµãËØïËá™Âä®ÂåñÊ°ÜÊû∂ÔºåÊèê‰æõ‰∫Ü‰∏ÄÂ•óÁâπÂÆöÁöÑËØ≠Ê≥ïÔºåÂπ∂‰∏îÊúâÈùûÂ∏∏‰∏∞ÂØåÁöÑÊµãËØïÂ∫ì „ÄÇ



###### robotÁî®‰æãÁÆÄ‰ªã

`robot/robot.txt`

```powershell
*** Settings ***
Library           RequestsLibrary
Library           SeleniumLibrary

*** Variables ***
${demo_url}       http://myblog.luffy/admin

*** Test Cases ***
api
    [Tags]  critical
    Create Session    api    ${demo_url}
    ${alarm_system_info}    RequestsLibrary.Get Request    api    /
    log    ${alarm_system_info.status_code}
    log    ${alarm_system_info.content}
    should be true    ${alarm_system_info.status_code} == 200

ui
    [Tags]  critical
    ${chrome_options} =     Evaluate    sys.modules['selenium.webdriver'].ChromeOptions()    sys, selenium.webdriver
    Call Method    ${chrome_options}   add_argument    headless
    Call Method    ${chrome_options}   add_argument    no-sandbox
    ${options}=     Call Method     ${chrome_options}    to_capabilities
    Open Browser    ${demo_url}/    browser=chrome       desired_capabilities=${options}
    sleep    2s
    Capture Page Screenshot
    Page Should Contain    Django
    close browser

```

```powershell
# ‰ΩøÁî®toolsÈïúÂÉèÂêØÂä®ÂÆπÂô®ÔºåÊù•È™åËØÅÊâãÂä®‰ΩøÁî®robotframeworkÊù•ÂÅöÈ™åÊî∂ÊµãËØï
$ docker run --rm -ti 172.21.51.143:5000/devops/tools:v2 bash
bash-5.0# apk add chromium chromium-chromedriver
$ cat requirements.txt
robotframework
robotframework-seleniumlibrary
robotframework-databaselibrary
robotframework-requests

#pipÂÆâË£ÖÂøÖË¶ÅÁöÑËΩØ‰ª∂ÂåÖ
$ python3 -m pip install --upgrade pip && pip3 install -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com -r requirements.txt 

#‰ΩøÁî®robotÂëΩ‰ª§ÂÅöÊµãËØï
$ robot -d artifacts/ robot.txt
```

###### ‰∏étoolsÂ∑•ÂÖ∑ÈïúÂÉèÈõÜÊàê

```powershell
FROM alpine:3.13.4
LABEL maintainer="inspur_lyx@hotmail.com"
USER root

RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apk/repositories && \
    apk update && \
    apk add  --no-cache openrc docker git curl tar gcc g++ make \
    bash shadow openjdk8 python2 python2-dev py-pip python3-dev openssl-dev libffi-dev \
    libstdc++ harfbuzz nss freetype ttf-freefont chromium chromium-chromedriver && \
    mkdir -p /root/.kube && \
    usermod -a -G docker root


COPY config /root/.kube/

COPY requirements.txt /

RUN python3 -m pip install --upgrade pip && pip3 install -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com -r requirements.txt 


RUN rm -rf /var/cache/apk/* && \
    rm -rf ~/.cache/pip

#-----------------ÂÆâË£Ö kubectl--------------------#
COPY kubectl /usr/local/bin/
RUN chmod +x /usr/local/bin/kubectl
# ------------------------------------------------#

#---------------ÂÆâË£Ö sonar-scanner-----------------#
COPY sonar-scanner /usr/lib/sonar-scanner
RUN ln -s /usr/lib/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner && chmod +x /usr/local/bin/sonar-scanner
ENV SONAR_RUNNER_HOME=/usr/lib/sonar-scanner
# ------------------------------------------------#

```



```powershell
$ docker build . -t 172.21.51.143:5000/devops/tools:v3

$ docker push 172.21.51.143:5000/devops/tools:v3
```



Êõ¥Êñ∞Jenkins‰∏≠kubernetes‰∏≠ÁöÑcontainers template



###### Êèí‰ª∂ÂÆâË£ÖÂèäÈÖçÁΩÆ

‰∏∫‰ªÄ‰πàË¶ÅÂÆâË£ÖrobotÊèí‰ª∂Ôºü

1. ÂÆâË£ÖrobotFramework

   - Êèí‰ª∂‰∏≠ÂøÉÊêúÁ¥¢robotframeworkÔºåÁõ¥Êé•ÂÆâË£Ö
   - toolsÈõÜÊàêrobotÂëΩ‰ª§Ôºà‰πãÂâçÂ∑≤ÁªèÂÆâË£ÖÔºâ

2. ‰∏éjenkinsfileÁöÑÈõÜÊàê

   ```groovy
       container('tools') {
           sh 'robot  -d artifacts/ robot.txt || echo ok'
           echo "R ${currentBuild.result}"
           step([
               $class : 'RobotPublisher',
               outputPath: 'artifacts/',
               outputFileName : "output.xml",
               disableArchiveOutput : false,
               passThreshold : 80,
               unstableThreshold: 20.0,
               onlyCritical : true,
               otherFiles : "*.png"
           ])
           echo "R ${currentBuild.result}"
           archiveArtifacts artifacts: 'artifacts/*', fingerprint: true
       }
   
   ```

   

###### ÂÆûË∑µÈÄöËøáJenkinsfileÂÆûÁé∞demoÈ°πÁõÆÁöÑÈ™åÊî∂ÊµãËØï

python-demoÈ°πÁõÆÊ∑ªÂä†robot.txtÊñá‰ª∂Ôºö

`jenkins/pipelines/p10.yaml`

```powershell
pipeline {
    agent { label 'jnlp-slave'}
    
    options {
		buildDiscarder(logRotator(numToKeepStr: '10'))
		disableConcurrentBuilds()
		timeout(time: 20, unit: 'MINUTES')
		gitLabConnection('gitlab')
	}

    environment {
        IMAGE_REPO = "172.21.51.143:5000/myblog"
        DINGTALK_CREDS = credentials('dingTalk')
        TAB_STR = "\n                    \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
    }

    stages {
        stage('git-log') {
            steps {
                script{
                    sh "git log --oneline -n 1 > gitlog.file"
                    env.GIT_LOG = readFile("gitlog.file").trim()
                }
                sh 'printenv'
            }
        }        
        stage('checkout') {
            steps {
                container('tools') {
                    checkout scm
                }
                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                script{
                    env.BUILD_TASKS = env.STAGE_NAME + "‚àö..." + env.TAB_STR
                }
            }
        }
        stage('CI'){
            failFast true
            parallel {
                stage('Unit Test') {
                    steps {
                        echo "Unit Test Stage Skip..."
                    }
                }
                stage('Code Scan') {
                    steps {
                        container('tools') {
                            withSonarQubeEnv('sonarqube') {
                                sh 'sonar-scanner -X'
                                sleep 3
                            }
                            script {
                                timeout(1) {
                                    def qg = waitForQualityGate('sonarqube')
                                    if (qg.status != 'OK') {
                                        error "Êú™ÈÄöËøáSonarqubeÁöÑ‰ª£Á†ÅË¥®ÈáèÈòàÊ£ÄÊü•ÔºåËØ∑ÂèäÊó∂‰øÆÊîπÔºÅfailure: ${qg.status}"
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
        stage('build-image') {
            steps {
                container('tools') {
                    retry(2) { sh 'docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}'}
                }
                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                script{
                    env.BUILD_TASKS += env.STAGE_NAME + "‚àö..." + env.TAB_STR
                }
            }
        }
        stage('push-image') {
            steps {
                container('tools') {
                    retry(2) { sh 'docker push ${IMAGE_REPO}:${GIT_COMMIT}'}
                }
                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                script{
                    env.BUILD_TASKS += env.STAGE_NAME + "‚àö..." + env.TAB_STR
                }
            }
        }
        stage('deploy') {
            steps {
                container('tools') {
                    sh "sed -i 's#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g' manifests/*"
                    timeout(time: 1, unit: 'MINUTES') {
                        sh "kubectl apply -f manifests/;sleep 20;"
                    }
                }
                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                script{
                    env.BUILD_TASKS += env.STAGE_NAME + "‚àö..." + env.TAB_STR
                }
            }
        }
        stage('Accept Test') {
            steps {
                    container('tools') {
                        sh 'robot -d artifacts/ robot.txt'
                        echo "R ${currentBuild.result}"
                        step([
                            $class : 'RobotPublisher',
                            outputPath: 'artifacts/',
                            outputFileName : "output.xml",
                            disableArchiveOutput : false,
                            passThreshold : 80,
                            unstableThreshold: 20.0,
                            onlyCritical : true,
                            otherFiles : "*.png"
                        ])
                        echo "R ${currentBuild.result}"
                        archiveArtifacts artifacts: 'artifacts/*', fingerprint: true
                    }
            }
        }
    }
    post {
        success { 
           container('tools') {
              echo 'Congratulations!'
              sh """
                curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \
                    -H 'Content-Type: application/json' \
                    -d '{
                        "msgtype": "markdown",
                        "markdown": {
                            "title":"myblog",
                            "text": "üòÑüëç ÊûÑÂª∫ÊàêÂäü üëçüòÑ  \n**È°πÁõÆÂêçÁß∞**Ôºöluffy  \n**Git log**: ${GIT_LOG}   \n**ÊûÑÂª∫ÂàÜÊîØ**: ${BRANCH_NAME}   \n**ÊûÑÂª∫Âú∞ÂùÄ**Ôºö${RUN_DISPLAY_URL}  \n**ÊûÑÂª∫‰ªªÂä°**Ôºö${BUILD_TASKS}"
                        }
                    }'
               """ 
           }
        }
        failure {
           container('tools') {
              echo 'Oh no!'
              sh """
                curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \
                    -H 'Content-Type: application/json' \
                    -d '{
                        "msgtype": "markdown",
                        "markdown": {
                            "title":"myblog",
                            "text": "üòñ‚ùå ÊûÑÂª∫Â§±Ë¥• ‚ùåüòñ  \n**È°πÁõÆÂêçÁß∞**Ôºöluffy  \n**Git log**: ${GIT_LOG}   \n**ÊûÑÂª∫ÂàÜÊîØ**: ${BRANCH_NAME}  \n**ÊûÑÂª∫Âú∞ÂùÄ**Ôºö${RUN_DISPLAY_URL}  \n**ÊûÑÂª∫‰ªªÂä°**Ôºö${BUILD_TASKS}"
                        }
                    }'
               """
           }
        }
        always { 
            echo 'I will always say Hello again!'
        }
    }
}
```

Âú®Jenkins‰∏≠Êü•ÁúãrobotÁöÑÊûÑÂª∫ÁªìÊûú„ÄÇ

