##### é›†æˆsonarQubeå®ç°ä»£ç æ‰«æ

Sonarå¯ä»¥ä»ä»¥ä¸‹ä¸ƒä¸ªç»´åº¦æ£€æµ‹ä»£ç è´¨é‡ï¼Œè€Œä½œä¸ºå¼€å‘äººå‘˜è‡³å°‘éœ€è¦å¤„ç†å‰5ç§ä»£ç è´¨é‡é—®é¢˜ã€‚

1. ä¸éµå¾ªä»£ç æ ‡å‡†
   sonarå¯ä»¥é€šè¿‡PMD,CheckStyle,Findbugsç­‰ç­‰ä»£ç è§„åˆ™æ£€æµ‹å·¥å…·è§„èŒƒä»£ç ç¼–å†™ã€‚
2. æ½œåœ¨çš„ç¼ºé™·
   sonarå¯ä»¥é€šè¿‡PMD,CheckStyle,Findbugsç­‰ç­‰ä»£ç è§„åˆ™æ£€æµ‹å·¥å…·æ£€ æµ‹å‡ºæ½œåœ¨çš„ç¼ºé™·ã€‚
3. ç³Ÿç³•çš„å¤æ‚åº¦åˆ†å¸ƒ
   æ–‡ä»¶ã€ç±»ã€æ–¹æ³•ç­‰ï¼Œå¦‚æœå¤æ‚åº¦è¿‡é«˜å°†éš¾ä»¥æ”¹å˜ï¼Œè¿™ä¼šä½¿å¾—å¼€å‘äººå‘˜ éš¾ä»¥ç†è§£å®ƒä»¬, ä¸”å¦‚æœæ²¡æœ‰è‡ªåŠ¨åŒ–çš„å•å…ƒæµ‹è¯•ï¼Œå¯¹äºç¨‹åºä¸­çš„ä»»ä½•ç»„ä»¶çš„æ”¹å˜éƒ½å°†å¯èƒ½å¯¼è‡´éœ€è¦å…¨é¢çš„å›å½’æµ‹è¯•ã€‚
4. é‡å¤
   æ˜¾ç„¶ç¨‹åºä¸­åŒ…å«å¤§é‡å¤åˆ¶ç²˜è´´çš„ä»£ç æ˜¯è´¨é‡ä½ä¸‹çš„ï¼Œsonarå¯ä»¥å±•ç¤º æºç ä¸­é‡å¤ä¸¥é‡çš„åœ°æ–¹ã€‚
5. æ³¨é‡Šä¸è¶³æˆ–è€…è¿‡å¤š
   æ²¡æœ‰æ³¨é‡Šå°†ä½¿ä»£ç å¯è¯»æ€§å˜å·®ï¼Œç‰¹åˆ«æ˜¯å½“ä¸å¯é¿å…åœ°å‡ºç°äººå‘˜å˜åŠ¨ æ—¶ï¼Œç¨‹åºçš„å¯è¯»æ€§å°†å¤§å¹…ä¸‹é™ è€Œè¿‡å¤šçš„æ³¨é‡Šåˆä¼šä½¿å¾—å¼€å‘äººå‘˜å°†ç²¾åŠ›è¿‡å¤šåœ°èŠ±è´¹åœ¨é˜…è¯»æ³¨é‡Šä¸Šï¼Œäº¦è¿èƒŒåˆè¡·ã€‚
6. ç¼ºä¹å•å…ƒæµ‹è¯•
   sonarå¯ä»¥å¾ˆæ–¹ä¾¿åœ°ç»Ÿè®¡å¹¶å±•ç¤ºå•å…ƒæµ‹è¯•è¦†ç›–ç‡ã€‚
7. ç³Ÿç³•çš„è®¾è®¡
   é€šè¿‡sonarå¯ä»¥æ‰¾å‡ºå¾ªç¯ï¼Œå±•ç¤ºåŒ…ä¸åŒ…ã€ç±»ä¸ç±»ä¹‹é—´çš„ç›¸äº’ä¾èµ–å…³ç³»ï¼Œå¯ä»¥æ£€æµ‹è‡ªå®šä¹‰çš„æ¶æ„è§„åˆ™ é€šè¿‡sonarå¯ä»¥ç®¡ç†ç¬¬ä¸‰æ–¹çš„jaråŒ…ï¼Œå¯ä»¥åˆ©ç”¨LCOM4æ£€æµ‹å•ä¸ªä»»åŠ¡è§„åˆ™çš„åº”ç”¨æƒ…å†µï¼Œ æ£€æµ‹è€¦åˆã€‚

###### sonarqubeæ¶æ„ç®€ä»‹

![](images\sonarqube.webp)

1. CSæ¶æ„
   - sonarqube scanner
   - sonarqube server
2. SonarQube Scanner æ‰«æä»ªåœ¨æœ¬åœ°æ‰§è¡Œä»£ç æ‰«æä»»åŠ¡
3. æ‰§è¡Œå®Œåï¼Œå°†åˆ†ææŠ¥å‘Šè¢«å‘é€åˆ°SonarQubeæœåŠ¡å™¨è¿›è¡Œå¤„ç†
4. SonarQubeæœåŠ¡å™¨å¤„ç†å’Œå­˜å‚¨åˆ†ææŠ¥å‘Šå¯¼è‡´SonarQubeæ•°æ®åº“ï¼Œå¹¶æ˜¾ç¤ºç»“æœåœ¨UIä¸­

###### sonarqube on kubernetesç¯å¢ƒæ­å»º

1. èµ„æºæ–‡ä»¶å‡†å¤‡

`sonar/sonar.yaml`

- å’Œgitlabå…±äº«postgresæ•°æ®åº“
- ä½¿ç”¨ingressåœ°å€ `sonar.luffy.com` è¿›è¡Œè®¿é—®
- ä½¿ç”¨initContainersè¿›è¡Œç³»ç»Ÿå‚æ•°è°ƒæ•´

```yaml
apiVersion: v1
kind: Service
metadata:
  name: sonarqube
  namespace: jenkins
  labels:
    app: sonarqube
spec:
  ports:
  - name: sonarqube
    port: 9000
    targetPort: 9000
    protocol: TCP
  selector:
    app: sonarqube
---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: jenkins
  name: sonarqube
  labels:
    app: sonarqube
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sonarqube
  template:
    metadata:
      labels:
        app: sonarqube
    spec:
      initContainers:
      - command:
        - /sbin/sysctl
        - -w
        - vm.max_map_count=262144
        image: alpine:3.6
        imagePullPolicy: IfNotPresent
        name: elasticsearch-logging-init
        resources: {}
        securityContext:
          privileged: true
      containers:
      - name: sonarqube
        image: sonarqube:7.9-community
        ports:
        - containerPort: 9000
        env:
        - name: SONARQUBE_JDBC_USERNAME
          valueFrom:
            secretKeyRef:
              name: gitlab-secret
              key: postgres.user.root
        - name: SONARQUBE_JDBC_PASSWORD
          valueFrom:
            secretKeyRef:
              name: gitlab-secret
              key: postgres.pwd.root
        - name: SONARQUBE_JDBC_URL
          value: "jdbc:postgresql://postgres:5432/sonar"
        livenessProbe:
          httpGet:
            path: /sessions/new
            port: 9000
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /sessions/new
            port: 9000
          initialDelaySeconds: 60
          periodSeconds: 30
          failureThreshold: 6
        resources:
          limits:
            cpu: 2000m
            memory: 4096Mi
          requests:
            cpu: 300m
            memory: 512Mi
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: sonarqube
  namespace: jenkins
spec:
  rules:
  - host: sonar.luffy.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service: 
            name: sonarqube
            port:
              number: 9000

```

2. sonarqubeæœåŠ¡ç«¯å®‰è£…

   ```bash
   # åˆ›å»ºsonaræ•°æ®åº“
   $ kubectl -n jenkins exec -ti postgres-5859dc6f58-mgqz9 bash
   #/ psql 
   # create database sonar;
   
   ## åˆ›å»ºsonarqubeæœåŠ¡å™¨
   $ kubectl create -f sonar.yaml
   
   ## é…ç½®æœ¬åœ°hostsè§£æ
   172.21.51.143 sonar.luffy.com
   
   ## è®¿é—®sonarqubeï¼Œåˆå§‹ç”¨æˆ·åå¯†ç ä¸º admin/admin
   $ curl http://sonar.luffy.com
   
   ```

3. sonar-scannerçš„å®‰è£…

   ä¸‹è½½åœ°å€ï¼š https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.2.0.1873-linux.zipã€‚è¯¥åœ°å€æ¯”è¾ƒæ…¢ï¼Œå¯ä»¥åœ¨ç½‘ç›˜ä¸‹è½½ï¼ˆhttps://pan.baidu.com/s/1SiEhWyHikTiKl5lEMX1tJg æå–ç : tqb9ï¼‰ã€‚

4. æ¼”ç¤ºsonarä»£ç æ‰«æåŠŸèƒ½

   - åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­å‡†å¤‡é…ç½®æ–‡ä»¶ **sonar-project.properties** 

     ```bash
     sonar.projectKey=myblog
     sonar.projectName=myblog
     # if you want disabled the DTD verification for a proxy problem for example, true by default
     sonar.coverage.dtdVerification=false
     # JUnit like test report, default value is test.xml
     sonar.sources=blog,myblog
     
     ```

   - é…ç½®sonarqubeæœåŠ¡å™¨åœ°å€

     ç”±äºsonar-scanneréœ€è¦å°†æ‰«æç»“æœä¸ŠæŠ¥ç»™sonarqubeæœåŠ¡å™¨åšè´¨é‡åˆ†æï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨sonar-scannerä¸­é…ç½®sonarqubeçš„æœåŠ¡å™¨åœ°å€ï¼š

     åœ¨é›†ç¾¤å®¿ä¸»æœºä¸­æµ‹è¯•ï¼Œå…ˆé…ç½®ä¸€ä¸‹hostsæ–‡ä»¶ï¼Œç„¶åé…ç½®sonarçš„åœ°å€ï¼š

     ```bash
     $ cat /etc/hosts
     172.21.51.143  sonar.luffy.com
     
     $ cat sonar-scanner/conf/sonar-scanner.properties
     #----- Default SonarQube server
     #sonar.host.url=http://localhost:9000
     sonar.host.url=http://sonar.luffy.com
     #----- Default source code encoding
     #sonar.sourceEncoding=UTF-8
     
     ```

  ```bash
   
# ä¸ºäº†ä½¿æ‰€æœ‰çš„podéƒ½å¯ä»¥é€šè¿‡`sonar.luffy.com`è®¿é—®ï¼Œå¯ä»¥é…ç½®corednsçš„é™æ€è§£æ
$ kubectl -n kube-system edit cm coredns 
...
             hosts {
                 172.21.51.143 jenkins.luffy.com gitlab.luffy.com sonar.luffy.com
                 fallthrough
          }
  ```

   - æ‰§è¡Œæ‰«æ

     ```bash
     ## åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œ
     $ /opt/sonar-scanner-4.2.0.1873-linux/bin/sonar-scanner  -X 
     
     ```

   - sonarqubeç•Œé¢æŸ¥çœ‹ç»“æœ

     ç™»å½•sonarqubeç•Œé¢æŸ¥çœ‹ç»“æœï¼ŒQuality Gatesè¯´æ˜


javaé¡¹ç›®çš„é…ç½®æ–‡ä»¶é€šå¸¸æ ¼å¼ä¸ºï¼š

```bash
sonar.projectKey=eureka-cluster
sonar.projectName=eureka-cluster
# if you want disabled the DTD verification for a proxy problem for example, true by default
# JUnit like test report, default value is test.xml
sonar.sources=src/main/java
sonar.language=java
sonar.tests=src/test/java
sonar.java.binaries=target/classes
```

###### æ’ä»¶å®‰è£…åŠé…ç½®

1. é›†æˆåˆ°toolså®¹å™¨ä¸­

   ç”±äºæˆ‘ä»¬çš„ä»£ç æ‹‰å–ã€æ„å»ºä»»åŠ¡å‡æ˜¯åœ¨toolså®¹å™¨ä¸­è¿›è¡Œï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŠŠscanneré›†æˆåˆ°æˆ‘ä»¬çš„toolså®¹å™¨ä¸­ï¼Œåˆå› ä¸ºscanneræ˜¯ä¸€ä¸ªcliå®¢æˆ·ç«¯ï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥æŠŠåŒ…è§£å‹å¥½ï¼Œæ‹·è´åˆ°toolså®¹å™¨å†…éƒ¨ï¼Œé…ç½®ä¸€ä¸‹PATHè·¯å¾„å³å¯ï¼Œæ³¨æ„ä¸¤ç‚¹ï¼š

   - ç›´æ¥åœ¨åœ¨toolsé•œåƒä¸­é…ç½®`http://sonar.luffy.com`

   - ç”±äºtoolså·²ç»é›†æˆäº†javaç¯å¢ƒï¼Œå› æ­¤å¯ä»¥ç›´æ¥å‰”é™¤scannerè‡ªå¸¦çš„jre

     - åˆ æ‰sonar-scanner/jreç›®å½•

     - ä¿®æ”¹sonar-scanner/bin/sonar-scanner

       `use_embedded_jre=false`

   ```bash
   $ cd tools
   $ cp -r /opt/sonar-scanner-4.2.0.1873-linux/ sonar-scanner
   ## sonaré…ç½®ï¼Œç”±äºæˆ‘ä»¬æ˜¯åœ¨Podä¸­ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é…ç½®ï¼šsonar.host.url=http://sonarqube:9000
   $ cat sonar-scanner/conf/sonar-scanner.properties
   #----- Default SonarQube server
   sonar.host.url=http://sonar.luffy.com
   
   #----- Default source code encoding
   #sonar.sourceEncoding=UTF-8
   
   $ rm -rf sonar-scanner/jre
   $ vi sonar-scanner/bin/sonar-scanner
   ...
   use_embedded_jre=false
   ...
   
   ```

   *Dockerfile*

   `jenkins/custom-images/tools/Dockerfile2`

   ```dockerfile
   FROM alpine:3.13.4
   LABEL maintainer="inspur_lyx@hotmail.com"
   USER root
   
   RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apk/repositories && \
       apk update && \
       apk add  --no-cache openrc docker git curl tar gcc g++ make \
       bash shadow openjdk8 python2 python2-dev py-pip python3-dev openssl-dev libffi-dev \
       libstdc++ harfbuzz nss freetype ttf-freefont && \
       mkdir -p /root/.kube && \
       usermod -a -G docker root
   
   COPY config /root/.kube/
   
   
   RUN rm -rf /var/cache/apk/*
   
   #-----------------å®‰è£… kubectl--------------------#
   COPY kubectl /usr/local/bin/
   RUN chmod +x /usr/local/bin/kubectl
   # ------------------------------------------------#
   
   #---------------å®‰è£… sonar-scanner-----------------#
   COPY sonar-scanner /usr/lib/sonar-scanner
   RUN ln -s /usr/lib/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner && chmod +x /usr/local/bin/sonar-scanner
   ENV SONAR_RUNNER_HOME=/usr/lib/sonar-scanner
   # ------------------------------------------------#
   
   ```

é‡æ–°æ„å»ºé•œåƒï¼Œå¹¶æ¨é€åˆ°ä»“åº“ï¼š

```bash
   $ docker build . -t 172.21.51.143:5000/devops/tools:v2
   $ docker push 172.21.51.143:5000/devops/tools:v2
   
```

2. ä¿®æ”¹Jenkins PodTemplate

   ä¸ºäº†åœ¨æ–°çš„æ„å»ºä»»åŠ¡ä¸­å¯ä»¥æ‹‰å–v2ç‰ˆæœ¬çš„toolsé•œåƒï¼Œéœ€è¦æ›´æ–°PodTemplate

3. å®‰è£…å¹¶é…ç½®sonaræ’ä»¶

   ç”±äºsonarqubeçš„æ‰«æçš„ç»“æœéœ€è¦è¿›è¡ŒQuality Gatesçš„æ£€æµ‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨å®¹å™¨ä¸­æ‰§è¡Œå®Œä»£ç æ‰«æä»»åŠ¡åï¼Œå¦‚ä½•çŸ¥é“æœ¬æ¬¡æ‰«ææ˜¯å¦é€šè¿‡äº†Quality Gatesï¼Œé‚£ä¹ˆå°±éœ€è¦å€ŸåŠ©äºsonarqubeå®ç°çš„jenkinsçš„æ’ä»¶ã€‚

   - å®‰è£…æ’ä»¶

     æ’ä»¶ä¸­å¿ƒæœç´¢sonarqubeï¼Œç›´æ¥å®‰è£…

   - é…ç½®æ’ä»¶

     ç³»ç»Ÿç®¡ç†->ç³»ç»Ÿé…ç½®-> **SonarQube servers** ->Add SonarQube

     - Nameï¼šsonarqube

     - Server URLï¼šhttp://sonar.luffy.com

     - Server authentication token

       â‘  ç™»å½•sonarqube -> My Account -> Security -> Generate Token

       â‘¡ ç™»å½•Jenkinsï¼Œæ·»åŠ å…¨å±€å‡­æ®ï¼Œç±»å‹ä¸ºSecret text

   - å¦‚ä½•åœ¨jenkinsfileä¸­ä½¿ç”¨

     æˆ‘ä»¬åœ¨ https://jenkins.io/doc/pipeline/steps/sonar/ å®˜æ–¹ä»‹ç»ä¸­å¯ä»¥çœ‹åˆ°ï¼š

     


###### Jenkinsfileé›†æˆsonarqubeæ¼”ç¤º

`jenkins/pipelines/p9.yaml`

```groovy
pipeline {
    agent { label 'jnlp-slave'}
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
        timeout(time: 20, unit: 'MINUTES')
        gitLabConnection('gitlab')
    }

    environment {
        IMAGE_REPO = "172.21.51.143:5000/myblog"
        DINGTALK_CREDS = credentials('dingTalk')
        TAB_STR = "\n                    \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
    }

    stages {
        stage('git-log') {
            steps {
                script{
                    sh "git log --oneline -n 1 > gitlog.file"
                    env.GIT_LOG = readFile("gitlog.file").trim()
                }
                sh 'printenv'
            }
        }        
        stage('checkout') {
            steps {
                container('tools') {
                    checkout scm
                }
                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                script{
                    env.BUILD_TASKS = env.STAGE_NAME + "âˆš..." + env.TAB_STR
                }
            }
        }
        stage('CI'){
            failFast true
            parallel {
                stage('Unit Test') {
                    steps {
                        echo "Unit Test Stage Skip..."
                    }
                }
                stage('Code Scan') {
                    steps {
                        container('tools') {
                            withSonarQubeEnv('sonarqube') {
                                sh 'sonar-scanner -X'
                                sleep 3
                            }
                            script {
                                timeout(1) {
                                    def qg = waitForQualityGate('sonarqube')
                                    if (qg.status != 'OK') {
                                        error "æœªé€šè¿‡Sonarqubeçš„ä»£ç è´¨é‡é˜ˆæ£€æŸ¥ï¼Œè¯·åŠæ—¶ä¿®æ”¹ï¼failure: ${qg.status}"
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
        stage('build-image') {
            steps {
                container('tools') {
                    retry(2) { sh 'docker build . -t ${IMAGE_REPO}:${GIT_COMMIT}'}
                }
                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                script{
                    env.BUILD_TASKS += env.STAGE_NAME + "âˆš..." + env.TAB_STR
                }
            }
        }
        stage('push-image') {
            steps {
                container('tools') {
                    retry(2) { sh 'docker push ${IMAGE_REPO}:${GIT_COMMIT}'}
                }
                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                script{
                    env.BUILD_TASKS += env.STAGE_NAME + "âˆš..." + env.TAB_STR
                }
            }
        }
        stage('deploy') {
            steps {
                container('tools') {
                    sh "sed -i 's#{{IMAGE_URL}}#${IMAGE_REPO}:${GIT_COMMIT}#g' manifests/*"
                    timeout(time: 1, unit: 'MINUTES') {
                        sh "kubectl apply -f manifests/"
                    }
                }
                updateGitlabCommitStatus(name: env.STAGE_NAME, state: 'success')
                script{
                    env.BUILD_TASKS += env.STAGE_NAME + "âˆš..." + env.TAB_STR
                }
            }
        }
    }

    post {
        success { 
           container('tools') {
              echo 'Congratulations!'
              sh """
                curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \
                    -H 'Content-Type: application/json' \
                    -d '{
                        "msgtype": "markdown",
                        "markdown": {
                            "title":"myblog",
                            "text": "ğŸ˜„ğŸ‘ æ„å»ºæˆåŠŸ ğŸ‘ğŸ˜„  \n**é¡¹ç›®åç§°**ï¼šluffy  \n**Git log**: ${GIT_LOG}   \n**æ„å»ºåˆ†æ”¯**: ${BRANCH_NAME}   \n**æ„å»ºåœ°å€**ï¼š${RUN_DISPLAY_URL}  \n**æ„å»ºä»»åŠ¡**ï¼š${BUILD_TASKS}"
                        }
                    }'
               """ 
           }
        }
        failure {
           container('tools') {
              echo 'Oh no!'
              sh """
                curl 'https://oapi.dingtalk.com/robot/send?access_token=${DINGTALK_CREDS_PSW}' \
                    -H 'Content-Type: application/json' \
                    -d '{
                        "msgtype": "markdown",
                        "markdown": {
                            "title":"myblog",
                            "text": "ğŸ˜–âŒ æ„å»ºå¤±è´¥ âŒğŸ˜–  \n**é¡¹ç›®åç§°**ï¼šluffy  \n**Git log**: ${GIT_LOG}   \n**æ„å»ºåˆ†æ”¯**: ${BRANCH_NAME}  \n**æ„å»ºåœ°å€**ï¼š${RUN_DISPLAY_URL}  \n**æ„å»ºä»»åŠ¡**ï¼š${BUILD_TASKS}"
                        }
                    }'
               """
           }
        }
        always { 
            echo 'I will always say Hello again!'
        }
    }
}

```

è‹¥Jenkinsæ‰§è¡Œä»»åŠ¡è¿‡ç¨‹ä¸­sonarqubeç«¯æŠ¥ç±»ä¼¼ä¸‹å›¾çš„é”™ï¼š
![](images\sonar-scanner-err.png)

åˆ™éœ€è¦åœ¨sonarqubeæœåŠ¡ç«¯è¿›è¡Œå¦‚ä¸‹é…ç½®ï¼Œæ·»åŠ ä¸€ä¸ªwebhookï¼š
![](images\fix-sonar-scanner-pending-err.png)